openapi: 3.0.3
info:
  title: Payment Gateway Service - Providers API
  version: 1.0.0
  description: |
    API for managing payment provider configurations including registration, updates, and status management.

    **Authentication**: All endpoints require JWT bearer token with admin role claims.

    **Security**: Provider credentials are encrypted at rest. Never expose sensitive credentials in responses.
  contact:
    name: MALIEV Platform Team
    email: platform@maliev.com

servers:
  - url: https://api.maliev.com/payment-gateway/v1
    description: Production
  - url: https://api-staging.maliev.com/payment-gateway/v1
    description: Staging
  - url: http://localhost:5000/v1
    description: Local Development

security:
  - BearerAuth: []

paths:
  /providers:
    get:
      summary: List Payment Providers
      description: Retrieves a list of all registered payment providers with their configurations (credentials excluded).
      operationId: listProviders
      tags:
        - Providers
      parameters:
        - name: status
          in: query
          required: false
          description: Filter providers by status
          schema:
            type: string
            enum: [active, disabled, degraded, maintenance]
        - name: currency
          in: query
          required: false
          description: Filter providers that support specific currency (ISO 4217 code)
          schema:
            type: string
            pattern: '^[A-Z]{3}$'
            example: "USD"
        - name: X-Correlation-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of payment providers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - providers
                  - total
                properties:
                  providers:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProviderSummary'
                  total:
                    type: integer
                    description: Total number of providers
                    example: 4
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Register Payment Provider
      description: |
        Registers a new payment provider with credentials and configuration.
        Credentials are automatically encrypted before storage.
      operationId: registerProvider
      tags:
        - Providers
      parameters:
        - name: X-Correlation-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterProviderRequest'
      responses:
        '201':
          description: Provider registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '400':
          description: Bad Request - Invalid configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflict - Provider with this name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /providers/{providerId}:
    get:
      summary: Get Provider Details
      description: Retrieves detailed information about a specific provider (credentials excluded).
      operationId: getProvider
      tags:
        - Providers
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: X-Correlation-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Provider details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '404':
          description: Not Found - Provider does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: Update Provider Configuration
      description: |
        Updates an existing provider's configuration. Supports partial updates.
        If credentials are provided, they will be re-encrypted.
      operationId: updateProvider
      tags:
        - Providers
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: X-Correlation-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProviderRequest'
      responses:
        '200':
          description: Provider updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '400':
          description: Bad Request - Invalid update data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not Found - Provider does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete Provider
      description: |
        Soft deletes a provider by setting is_archived = true.
        Cannot delete if there are pending transactions using this provider.
      operationId: deleteProvider
      tags:
        - Providers
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: X-Correlation-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Provider deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not Found - Provider does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflict - Cannot delete provider with active transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /providers/{providerId}/status:
    patch:
      summary: Update Provider Status
      description: Updates only the operational status of a provider (active, disabled, maintenance).
      operationId: updateProviderStatus
      tags:
        - Providers
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: X-Correlation-Id
          in: header
          required: false
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [active, disabled, maintenance]
                  description: New operational status
                reason:
                  type: string
                  description: Reason for status change
                  maxLength: 500
      responses:
        '200':
          description: Provider status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '400':
          description: Bad Request - Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token with admin role claims

  schemas:
    RegisterProviderRequest:
      type: object
      required:
        - name
        - displayName
        - providerType
        - apiEndpoint
        - credentials
        - supportedCurrencies
      properties:
        name:
          type: string
          description: Unique provider name (alphanumeric, underscore, hyphen)
          pattern: '^[a-zA-Z0-9_-]+$'
          minLength: 2
          maxLength: 100
          example: "Stripe"
        displayName:
          type: string
          description: Human-readable display name
          maxLength: 255
          example: "Stripe Payments"
        providerType:
          type: string
          description: Provider type identifier for factory pattern
          enum: [stripe, paypal, omise, scb]
          example: "stripe"
        apiEndpoint:
          type: string
          format: uri
          description: Base API endpoint URL
          example: "https://api.stripe.com"
        webhookEndpoint:
          type: string
          format: uri
          description: Public webhook URL for this provider
          example: "https://api.maliev.com/payment-gateway/v1/webhooks/stripe"
        credentials:
          type: object
          description: Provider API credentials (will be encrypted)
          additionalProperties: true
          example:
            apiKey: "sk_test_1234567890"
            secretKey: "whsec_1234567890"
        supportedCurrencies:
          type: array
          description: List of supported ISO 4217 currency codes
          items:
            type: string
            pattern: '^[A-Z]{3}$'
          minItems: 1
          example: ["USD", "EUR", "GBP", "THB"]
        supportedPaymentMethods:
          type: array
          description: List of supported payment methods
          items:
            type: string
            enum: [card, bank_transfer, qr_code, wallet]
          example: ["card", "wallet"]
        priority:
          type: integer
          description: Routing priority (lower = higher priority, default 100)
          minimum: 1
          default: 100
          example: 1
        rateLimitPerSecond:
          type: integer
          description: Maximum requests per second (null = no limit)
          minimum: 1
          nullable: true
          example: 100
        timeoutSeconds:
          type: integer
          description: Timeout for API calls in seconds (default 30)
          minimum: 5
          maximum: 120
          default: 30
          example: 30
        maxRetryAttempts:
          type: integer
          description: Maximum retry attempts (default 3)
          minimum: 0
          maximum: 10
          default: 3
          example: 3
        enableCircuitBreaker:
          type: boolean
          description: Whether to enable circuit breaker (default true)
          default: true
          example: true
        circuitBreakerThreshold:
          type: number
          format: decimal
          description: Failure ratio threshold for circuit breaker (default 0.5)
          minimum: 0.1
          maximum: 1.0
          default: 0.5
          example: 0.5
        isSandbox:
          type: boolean
          description: Whether this is a sandbox/test environment
          default: false
          example: true
        configurationMetadata:
          type: object
          description: Additional provider-specific configuration
          additionalProperties: true
          nullable: true

    UpdateProviderRequest:
      type: object
      description: Partial update of provider configuration
      properties:
        displayName:
          type: string
          maxLength: 255
        apiEndpoint:
          type: string
          format: uri
        webhookEndpoint:
          type: string
          format: uri
        credentials:
          type: object
          description: Updated credentials (will be re-encrypted)
          additionalProperties: true
        supportedCurrencies:
          type: array
          items:
            type: string
            pattern: '^[A-Z]{3}$'
        supportedPaymentMethods:
          type: array
          items:
            type: string
        priority:
          type: integer
          minimum: 1
        rateLimitPerSecond:
          type: integer
          minimum: 1
          nullable: true
        timeoutSeconds:
          type: integer
          minimum: 5
          maximum: 120
        maxRetryAttempts:
          type: integer
          minimum: 0
          maximum: 10
        enableCircuitBreaker:
          type: boolean
        circuitBreakerThreshold:
          type: number
          format: decimal
          minimum: 0.1
          maximum: 1.0
        configurationMetadata:
          type: object
          additionalProperties: true

    ProviderSummary:
      type: object
      required:
        - id
        - name
        - displayName
        - status
        - supportedCurrencies
        - priority
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "Stripe"
        displayName:
          type: string
          example: "Stripe Payments"
        status:
          type: string
          enum: [active, disabled, degraded, maintenance]
          example: "active"
        supportedCurrencies:
          type: array
          items:
            type: string
          example: ["USD", "EUR", "GBP"]
        priority:
          type: integer
          example: 1
        successRate15Min:
          type: number
          format: decimal
          description: Success rate over last 15 minutes (percentage)
          example: 99.8
          nullable: true
        lastHealthCheck:
          type: string
          format: date-time
          nullable: true
        isSandbox:
          type: boolean
          example: true

    ProviderResponse:
      type: object
      required:
        - id
        - name
        - displayName
        - status
        - providerType
        - apiEndpoint
        - supportedCurrencies
        - priority
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "Stripe"
        displayName:
          type: string
          example: "Stripe Payments"
        status:
          type: string
          enum: [active, disabled, degraded, maintenance]
          example: "active"
        providerType:
          type: string
          example: "stripe"
        apiEndpoint:
          type: string
          example: "https://api.stripe.com"
        webhookEndpoint:
          type: string
          example: "https://api.maliev.com/payment-gateway/v1/webhooks/stripe"
          nullable: true
        supportedCurrencies:
          type: array
          items:
            type: string
          example: ["USD", "EUR", "GBP", "THB"]
        supportedPaymentMethods:
          type: array
          items:
            type: string
          example: ["card", "wallet"]
          nullable: true
        priority:
          type: integer
          example: 1
        rateLimitPerSecond:
          type: integer
          example: 100
          nullable: true
        timeoutSeconds:
          type: integer
          example: 30
        maxRetryAttempts:
          type: integer
          example: 3
        enableCircuitBreaker:
          type: boolean
          example: true
        circuitBreakerThreshold:
          type: number
          format: decimal
          example: 0.5
          nullable: true
        successRate15Min:
          type: number
          format: decimal
          example: 99.8
          nullable: true
        lastHealthCheck:
          type: string
          format: date-time
          nullable: true
        isSandbox:
          type: boolean
          example: true
        createdAt:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-11-18T10:30:00Z"
        configurationMetadata:
          type: object
          additionalProperties: true
          nullable: true

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - timestamp
      properties:
        error:
          type: string
          example: "PROVIDER_NOT_FOUND"
        message:
          type: string
          example: "The specified provider does not exist"
        details:
          type: object
          additionalProperties: true
          nullable: true
        timestamp:
          type: string
          format: date-time
          example: "2025-11-18T10:30:00Z"
        correlationId:
          type: string
          format: uuid
          nullable: true
